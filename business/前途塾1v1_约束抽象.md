# 前途塾 1v1 约课系统：约束抽象（学生-老师-教室-流程）

> 目标：把 Excel 中的自由文本需求，抽象为少量、规范、可组合的约束类型，支持 **可行性判断（hard）** 与 **偏好排序（soft）**，并与老师/教室资源一起完成“学生-老师-房间”的匹配与排课。

---

## 0. 统一约束公共字段（所有 constraint 都带）

```json
{
  "id": "cst_001",
  "kind": "time_window | blackout | fixed_slot | horizon | session_plan | resource_preference | no_overlap | strategy | entitlement | workflow_gate",
  "strength": "hard | soft | info",
  "priority": 0,
  "scope": { "orderId": "o_x", "studentId": "s_x", "courseId": "c_x" },
  "note": "原始备注/补充说明",
  "source": ["起止时间", "学生希望时间段", "希望具体时间", "每周频次", "备注", "教务备注"],
  "confidence": 0.0
}
```
- **strength**
  - `hard`：不可违反（禁排、锁定、截止、资格门禁等）
  - `soft`：尽量满足（偏好校区/老师、尽量周末等）
  - `info`：仅记录（暂不参与求解）
- **priority**：软约束之间的排序（数值越大越优先）
- **source/confidence**：从多列自由文本归一时用于回溯与打分权重

---

## 1) 学生侧：最小手动约束类型（10 类）

### 1. time_window（可上/偏好/允许的时间集合）
覆盖：周几/上午下午晚上/某日期范围可上课等。

```json
{
  "kind": "time_window",
  "operator": "allow | prefer",
  "dateRange": { "start": "YYYY-MM-DD", "end": "YYYY-MM-DD" },
  "weekdays": [1,2,3,4,5,6,7],
  "timeRanges": [{"start":"HH:MM","end":"HH:MM"}],
  "timezone": "Asia/Tokyo"
}
```

### 2. blackout（禁排时间集合）
覆盖：语校时段不可排、回国期间不上课、某天某时段不能排等。

```json
{
  "kind": "blackout",
  "dateRange": { "start": "YYYY-MM-DD", "end": "YYYY-MM-DD" },
  "weekdays": [1,2,3,4,5,6,7],
  "timeRanges": [{"start":"HH:MM","end":"HH:MM"}],
  "reason": "language_school | travel | fixed_event | other"
}
```

### 3. fixed_slot（固定课/已约定时间）
覆盖：与老师已商定、必须某天某时。

```json
{
  "kind": "fixed_slot",
  "slots": [{"start":"YYYY-MM-DDTHH:MM","end":"YYYY-MM-DDTHH:MM"}],
  "locked": true
}
```

### 4. horizon（最早/最晚/截止）
覆盖：xx之前上完、xx之后到yy之前都可以、必须在某日完成等。

```json
{
  "kind": "horizon",
  "earliest": "YYYY-MM-DD",
  "latest": "YYYY-MM-DD",
  "mustFinishBy": "YYYY-MM-DD"
}
```

### 5. session_plan（次数/频次/时长/总课时/特殊课）
覆盖：1次/多次/一周几次/2小时/3小时/总共N次/可取消最后一次等。

```json
{
  "kind": "session_plan",
  "totalSessions": 8,
  "sessionDurationMin": 120,
  "sessionsPerWeek": 2,
  "totalHours": 40,
  "specialSessions": [
    { "count": 1, "durationMin": 180, "within": {"start":"YYYY-MM-DD","end":"YYYY-MM-DD"} }
  ],
  "allowCancelLastIfReady": true
}
```

### 6. resource_preference（资源偏好/禁用/指定）
统一表达：指定老师/不要某老师/尽量板桥/旗舰校区/线上线下偏好/房间偏好等。

```json
{
  "kind": "resource_preference",
  "resourceType": "teacher | campus | room | delivery_mode",
  "include": ["t_x"],
  "exclude": ["t_y"],
  "prefer": ["campus_板桥", "room_个别指导室1"],
  "mustBeSameResource": false
}
```

### 7. no_overlap（不可重叠/避免冲突）
覆盖：不要与某课/某事件冲突，支持缓冲。

```json
{
  "kind": "no_overlap",
  "with": [
    { "type": "existing_class", "id": "class_123" },
    { "type": "named_event", "title": "面试课", "time": {"start":"...","end":"..."} }
  ],
  "bufferMin": 0
}
```

### 8. strategy（排布策略/阶段目标）
覆盖：平均分布、两周内分散完成、先写稿后练面试、某日期前至少上N次等。

```json
{
  "kind": "strategy",
  "rules": [
    { "type": "spread_evenly", "granularity": "week" },
    { "type": "min_sessions_by_date", "count": 4, "by": "YYYY-MM-DD" },
    { "type": "order_sessions", "sequence": ["draft", "practice"] }
  ]
}
```

### 9. entitlement（课时资格/订单编码/到账门禁）
来源：`所用课时` + `教务备注`（课时编码/ERP编码/到账信息）。影响“是否允许进入排课/是否允许发放”。

```json
{
  "kind": "entitlement",
  "sourceType": "local | erp | mixed",
  "orderCodes": ["20252413", "ERP1023"],
  "paymentStatus": "paid | pending | unknown",
  "paidAt": "YYYY-MM-DD"
}
```

### 10. workflow_gate（流程状态机门禁）
来源：教务流程布尔列（学生课时确认→讲师时间确认→教室确定→…）。用于控制哪些动作可执行。

```json
{
  "kind": "workflow_gate",
  "state": "draft | entitlement_checked | teacher_time_checked | room_assigned | timetable_built | reconfirm_teacher | confirm_student | posted_dingtalk | released_teacher | released_student | finalized | manager_signed",
  "guards": [
    { "from":"teacher_time_checked", "requires":["学生课时确认==true"] },
    { "from":"room_assigned", "requires":["讲师时间确认==true"] },
    { "from":"timetable_built", "requires":["教室确定!=null"] }
  ]
}
```

---

## 2) 老师侧：画像与可用性抽象（用于匹配）

### 2.1 TeacherProfile（静态画像）
```json
{
  "teacherId": "t_lin_bojie",
  "name": "林博杰",
  "gender": "male|female|unknown",
  "employmentType": "full_time|part_time",
  "rating": 2,
  "hourlyRate": 2300,
  "yearsExperience": 3,

  "almaMater": "关西大学",
  "disciplineGroup": "文|理|文理兼修",
  "major": "建筑学",
  "fieldTags": ["建筑","工学"],

  "capabilities": ["志望理由书_指导", "大学面试练习", "EJU日语"],
  "serviceSwitches": { "canEditSOP10Days": true },

  "deliveryModes": ["online","offline"],
  "allowedCampuses": ["旗舰校","东京本校（板桥第二校舍）","高马本校","VIP中心"],
  "allowedRoomTypes": ["个别指导室","VIP教室","教室"],

  "styleTags": ["systematic","patient","heuristic"],
  "methodTags": ["breakthrough","adaptive","motivation"]
}
```

### 2.2 TeacherAvailability（可带时间 + 已确认课时锁定）
> 可用性与学生侧 time_window/blackout/fixed_slot 结构同构，便于做交集。

```json
{
  "availability": [
    { "kind":"time_window","operator":"allow","weekdays":[1,3,5],"timeRanges":[{"start":"14:00","end":"22:00"}] }
  ],
  "confirmedSlots": [
    { "start":"YYYY-MM-DDTHH:MM","end":"YYYY-MM-DDTHH:MM","status":"confirmed|tentative" }
  ]
}
```

---

## 3) 教室/房间资源：真实数据抽象（系统配置，不是手动约束）

### 3.1 Room（最小配置 Schema）
字段来自你提供的真实表：校区/区域类别/教室名/录入名称/类型/优先级/时间段/班容。

```json
{
  "roomId": "tokyo_ban2_101",
  "campus": "东京本校（板桥第二校舍）",
  "category": "教室",
  "type": "教室",
  "name": "101",
  "entryName": "板二101",
  "aliases": ["板二101","101"],

  "priority": 5,
  "capacity": 30,
  "openHours": [
    { "weekdays":[1,2,3,4,5,6,7], "timeRanges":[{"start":"09:30","end":"21:00"}] }
  ],
  "tags": []
}
```

### 3.2 CampusAlias（校区枚举与别名映射）
> 学生表常见 `高马/本校` 与房间表 `旗舰校/东京本校（板桥第二校舍）/高马本校/VIP中心` 必须归一，否则无法正确选房间。

```json
{
  "campusAliases": [
    { "alias": "高马", "mapsTo": ["高马本校"] },
    { "alias": "本校", "mapsTo": ["东京本校（板桥第二校舍）","旗舰校","VIP中心"] },
    { "alias": "板桥", "mapsTo": ["东京本校（板桥第二校舍）"] },
    { "alias": "旗舰", "mapsTo": ["旗舰校"] }
  ]
}
```

### 3.3 RoomEligibilityRule（1v1 选房规则）
> 防止 1v1 被排到自习室/事务所等不合规房间。

```json
{
  "roomEligibilityRules": [
    { "courseMode": "1v1", "allowedRoomTypes": ["个别指导室","VIP教室","教室"] },
    { "courseMode": "1v1", "disallowedRoomTypes": ["自习室","自习教室","事务所"] }
  ]
}
```

### 3.4 RoomPolicy（软策略：优先排房间）
> 例如“旗舰校个别指导室空闲时优先 1/3/5”。这是 **系统策略**，不需要学管手动输入。

```json
{
  "policies": [
    {
      "if": { "campus":"旗舰校", "type":"个别指导室" },
      "preferRooms": ["个别指导室1","个别指导室3","个别指导室5"],
      "weight": 2.0
    }
  ]
}
```

### 3.5 online 的处理原则
- `online` **不是房间**，而是 `delivery_mode=online`
- 线上课：不分配 room，只检查 teacher availability 与 student 时间
- 线下课：必须分配 room，并检查 room openHours/容量/类型/校区

---

## 4) 课程/科目字典化（强烈建议）

### 4.1 Subject（上课内容）标准枚举
Excel 中 `上课内容` 有 14 种（且会增长），必须字典化：
- `大学面试练习`
- `志望理由书_指导（带着写）`
- `志望理由书_修改（纯修改）`
- `EJU_日语 / EJU_文综 / EJU_文数 / EJU_理数 / EJU_化学 / 生物`
- `校内考_小论文 / 校内考_日语`
- `托福 / JLPT_N1`
- `其他`（必须落到备注或二级字段）

### 4.2 TimeBucket（上午/下午/晚上）固定口径
文本中的“上午/下午/晚上/工作日晚上”等必须产品化：
- 建议默认：上午 `09:00-12:00`；下午 `13:00-17:00`；晚上 `18:00-22:00`
- 结合校区 openHours 做裁剪（如东京本校 09:30 开放）

---

## 5) 匹配与排课：硬过滤与软排序（推荐流程）

### 5.1 硬过滤（Hard Eligibility）
1. entitlement 通过（课时可用/到账规则）
2. 老师能力匹配：`subject ∈ teacher.capabilities`
3. 形式匹配：`student.delivery_mode ∩ teacher.deliveryModes != ∅`
4. 时间交集可行：`student time constraints ∩ teacher availability` 存在可行 slot
5. 若线下：房间可行：`room openHours ∩ slot` 且 roomType 合规，且校区可用

### 5.2 软排序（Soft Scoring）
建议 6 个维度（权重可调）：
- timeFit：与 `prefer` 窗口重合度、满足固定/避让程度
- preferenceFit：指定/偏好老师、校区偏好
- quality：rating/教龄
- cost：时薪
- styleFit：风格标签匹配（如鼓励式/耐心）
- roomScore：room.priority + roomPolicy

---

## 6) 实施要点（工程落地）

1. **归一化层（normalize）**：把 `起止时间/希望时间段/希望具体时间/每周频次/备注/教务备注` 解析为 constraints（带 source/confidence）。
2. **资源层（catalog）**：老师表、教室表字典化并落库，支持别名映射。
3. **求解层（feasible + score）**：先过滤可行老师/房间，再按软偏好排序或做全局排程。
4. **流程层（workflow）**：布尔列实现为状态机 gate，控制“可制作/可发放/可最终确认”。

---

## 附：你提供的教室数据关键差异（必须建模）
- 东京本校开放时间：`09:30-21:00`
- 旗舰/高马/VIP：`09:00-21:30`
- roomType 多样：班课/个别指导室/VIP/教室/自习/事务所（1v1 必须做 eligibility）
- `录入名称`（如“板二101”）是业务侧常用键，必须做别名匹配

