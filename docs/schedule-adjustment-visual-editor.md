# 排课调整可视化编辑器功能说明

**Created:** 2026-02-05 18:20:00 (Tokyo Time)
**Last Updated:** 2026-02-05 18:20:00 (Tokyo Time)
**Purpose:** 说明排课调整功能的可视化编辑器新特性

---

## 概述

在原有的"复制粘贴Excel数据"功能基础上，新增了**可视化编辑器**，允许用户通过下拉选择、复选框、时间选择器等交互式控件修改学生、教师和教室数据，并一键触发重新排课。

## 主要特性

### 1. 双模式编辑

在排课调整界面中，提供两种编辑模式：

#### 粘贴模式（原有功能保留）
- 支持从Excel复制数据并粘贴到文本框
- 适合批量数据导入
- 需要手动输入修改原因

#### 选择模式（新增）
- 提供图形化界面进行数据修改
- 支持下拉选择、复选框、时间选择器等控件
- 自动触发重新排课
- 所见即所得的编辑体验

### 2. 模式切换

在"手动修改"区域的标题栏右侧，有两个切换按钮：

- **粘贴** 按钮：切换到传统的文本粘贴模式
- **选择** 按钮：切换到可视化编辑模式

### 3. 数据类型支持

#### 学生数据编辑
- **基本信息**：姓名、校区、科目
- **课程设置**：课时、频率、时长、授课方式、学员等级
- **教师偏好**：从下拉列表选择偏好教师
- **时间约束**：
  - 可用天数选择（周一至周日多选）
  - 快速选择（工作日/周末/全选）
  - 动态时间段添加/删除
  - 时间选择器（精确到分钟）

#### 教师数据编辑
- 教师姓名
- 可授科目（多选）
- 可授校区（多选）

#### 教室数据编辑
- 教室名称
- 所属校区
- 容纳人数

### 4. 可视化编辑器界面组件

#### 表单控件
- **文本输入框**：姓名等文本字段
- **下拉选择器**：校区、科目、授课方式等
- **数字输入框**：课时、容纳人数等
- **复选框组**：可用天数、可授科目、可授校区
- **时间选择器**：时间段的开始和结束时间

#### 时间段管理
- **添加时间段按钮**：动态增加新的可用时间段
- **删除按钮**：移除不需要的时间段
- **每日独立设置**：可为每个时间段指定具体星期

#### 操作按钮
- **应用修改并重新排课**：保存所有修改并立即触发重新排课算法

## 使用流程

### 可视化编辑模式使用步骤

1. **进入排课调整界面**
   - 点击"排课调整"按钮
   - 系统显示存在冲突的学生列表

2. **选择冲突学生**
   - 在左侧列表中点击需要调整的学生

3. **切换到可视化编辑模式**
   - 在右侧调整面板的"手动修改"区域
   - 点击右上角的"选择"按钮

4. **选择编辑数据类型**
   - 在"学生数据"、"教师数据"、"教室数据"标签页之间切换

5. **修改数据**
   - 使用下拉选择器修改校区、科目等
   - 使用复选框选择可用天数
   - 使用时间选择器设置时间段
   - 点击"+"按钮添加更多时间段
   - 点击"×"按钮删除不需要的时间段

6. **应用并重新排课**
   - 点击底部的"应用修改并重新排课"按钮
   - 系统自动保存修改并触发排课算法
   - 等待排课结果

7. **查看结果**
   - 如果排课成功，冲突被解决
   - 如果仍有冲突，继续调整或尝试其他建议

## 技术实现

### 核心组件

#### VisualEditor.jsx
可视化编辑器主组件，负责：
- 渲染表单控件
- 管理表单状态（useState）
- 处理用户交互
- 时间槽转换（slotToTime / timeToSlot）
- 数据结构化并回调

#### AdjustmentPanel.jsx
调整面板组件，集成：
- 模式切换控制
- 粘贴模式和可视化模式的条件渲染
- 数据传递给 VisualEditor

#### ScheduleAdjustmentModal.jsx
主模态框，负责：
- 协调调整服务（ScheduleAdjustmentService）
- 处理可视化编辑的结构化数据
- 触发重新排课算法

### 数据流

```
用户操作 (VisualEditor)
  ↓
formData / timeRanges / selectedDays
  ↓
handleApplyAndRetry (VisualEditor)
  ↓
onApplyAndRetry callback (AdjustmentPanel)
  ↓
handleVisualEditAndRetry (AdjustmentPanel)
  ↓
onManualModify (ScheduleAdjustmentModal)
  ↓
handleManualModify (ScheduleAdjustmentModal)
  ↓
adjustmentService.modifyData (批量应用字段修改)
  ↓
onRetrySchedule (ScheduleAdjustmentModal)
  ↓
handleRetrySchedule (ScheduleAdjustmentModal)
  ↓
adjustmentService.retryScheduleForStudent
  ↓
algorithmAdapter.schedule
  ↓
排课结果 / 冲突状态更新
```

### 时间槽转换

系统内部使用 **10分钟时间槽** 系统（0-149，对应 06:00-25:00）：

- **slotToTime(slot)**: 槽索引 → "HH:MM" 格式
- **timeToSlot(timeStr)**: "HH:MM" → 槽索引

示例：
- `slotToTime(0)` → "06:00"
- `slotToTime(54)` → "15:00"
- `timeToSlot("18:30")` → 75

## 样式设计

### 主题支持
- 完整的亮色/暗色主题支持
- 响应式设计，适配不同屏幕尺寸

### 交互反馈
- 按钮悬停效果
- 活动状态高亮
- 禁用状态视觉提示
- 加载状态显示

### 布局
- 模块化表单布局
- 响应式网格系统
- 清晰的视觉层次
- 合理的间距和对齐

## 与原有功能的兼容性

### 粘贴模式完全保留
原有的复制粘贴Excel数据功能完全保留，不受影响：
- 手动编辑区域的文本框和修改原因输入框
- 保存修改按钮
- 重新尝试按钮
- 跳过/下一个按钮

### 独立的操作流程
- 粘贴模式：需要手动保存，然后手动点击"重新尝试"
- 选择模式：一键完成修改和重新排课

## 注意事项

1. **数据验证**
   - 时间段的开始时间必须早于结束时间
   - 必须至少选择一个可用天数
   - 所有必填字段必须填写

2. **修改跟踪**
   - 所有修改都会记录到 `modificationHistory`
   - 可通过"查看历史"功能查看修改记录

3. **性能考虑**
   - 时间段数量建议不超过10个
   - 避免过于复杂的时间约束组合

4. **排课算法**
   - 修改后自动触发的是单学生重新排课
   - 如果需要批量重试，使用底部的"批量重试"按钮

## 未来扩展

### 计划中的功能
1. **模板保存**：保存常用的时间约束模板
2. **批量编辑**：同时修改多个学生的相同字段
3. **冲突预览**：在应用修改前预览可能的冲突
4. **撤销/重做**：支持编辑操作的撤销和重做
5. **数据验证增强**：更智能的数据有效性检查

### 技术优化
1. 引入表单库（如 react-hook-form）简化状态管理
2. 添加数据缓存机制，避免重复计算
3. 优化大数据量下的渲染性能

## 相关文档

- [排课系统核心功能技术文档](./排课系统核心功能技术文档.md)
- [排课调整功能实施总结](./schedule-adjustment-implementation.md)
- [约束系统实施指南](./experiment3-constraint-system-guide.md)

## 总结

可视化编辑器为排课调整提供了更直观、更高效的操作方式，特别适合：
- 频繁调整时间约束的场景
- 需要精确控制可用时间段的情况
- 快速试错和迭代优化排课结果

同时保留了原有的粘贴模式，确保用户可以根据实际需求选择最适合的编辑方式。
