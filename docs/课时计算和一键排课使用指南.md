# 课时计算和一键排课使用指南

**Created:** 2026-01-23  
**Last Updated:** 2026-01-23  
**Purpose:** 说明新的课时计算逻辑、有效周期解析和悬浮一键排课按钮的使用方法

---

## 🎯 核心更新

### 1. 智能课时计算系统

**旧方式**：依赖列22"学生课时确认"字段

**新方式**：基于上课频次和时长自动计算

#### 计算公式

```
每周课时 = 上课频次 × 单次时长
总课时 = 每周课时 × 预估周数（默认12周）
```

#### 支持的格式

**上课频次（列5）：**
- `多次` → 默认4次/周
- `2次` → 2次/周  
- `每周3` → 3次/周
- `week 2` → 2次/周
- `3times` → 3次/周
- `2` → 2次/周

**上课时长（列6）：**
- `1小时` → 1小时
- `1.5小时` → 1.5小时
- `2h` → 2小时
- `90分钟` → 1.5小时
- `90min` → 1.5小时
- `2` → 2小时

#### 示例

| 上课频次 | 上课时长 | 每周课时 | 总课时(12周) |
|---------|---------|---------|------------|
| 2次 | 2小时 | 4小时 | 48小时 |
| 多次 | 1.5小时 | 6小时 | 72小时 |
| 每周3 | 1小时 | 3小时 | 36小时 |
| 2 | 90分钟 | 3小时 | 36小时 |

### 2. 有效周期智能解析

系统会结合以下字段自动推算学生合约有效期：

**输入字段：**
- **列4：录入日期**（如：`2024-01-15`）
- **列13：起止时间**（如：`1月-3月`、`2024.1.15-2024.3.31`）

**支持格式：**

#### 完整日期范围
- `2024.1.15-2024.3.31`
- `2024-01-15 至 2024-03-31`
- `2024/01/15~2024/03/31`

#### 月份范围
- `1月-3月` → 使用录入年份
- `1月~3月`

#### 季节
- `春季` → 3月-5月
- `夏季` → 6月-8月
- `秋季` → 9月-11月
- `冬季` → 12月-次年2月

#### 时长描述
- `3个月` → 从录入日期起3个月
- `12周` → 从录入日期起12周

#### 单一日期
- 如晚于录入日期，视为结束日期
- 如早于或等于录入日期，视为开始日期

**解析逻辑：**
1. 优先解析完整日期范围
2. 若只有起始日期，估算12周后为结束日期
3. 若只有结束日期，倒推12周为开始日期
4. 若都没有，使用录入日期起12周

### 3. 悬浮一键排课按钮

#### 位置
**固定在屏幕右下角**，始终可见

#### 三种状态

**状态1：禁用（灰色圆形）**
```
条件：
- 没有导入学生数据
- 或所有学生都没有有效课时
外观：
- 灰色圆形按钮
- 不可点击
- 提示："请先导入有课时的学生数据"
```

**状态2：待选择（灰色椭圆）**
```
条件：
- 有学生数据且有课时
- 但没有选中任何学生
外观：
- 灰色椭圆按钮
- 显示"一键排课"文字
- 不可点击
- 提示："请至少选择一个学生"
```

**状态3：可排课（紫色椭圆 + 角标）**
```
条件：
- 已选中至少1名学生
外观：
- 紫色渐变椭圆按钮
- 显示"一键排课"文字
- 右上角显示选中人数角标
- 悬停时上浮效果
- 提示："为X名学生排课"
```

**状态4：排课中**
```
外观：
- 紫色椭圆按钮
- 显示加载动画
- 显示"排课中"文字
- 显示进度百分比
- 禁用状态
```

#### 排课进度浮层

排课时会显示全屏半透明浮层：
- 显示当前处理的学生
- 显示进度条
- 显示百分比
- 用户无法操作其他内容

## 📋 完整使用流程

### 步骤1：准备Excel数据

确保Excel包含以下关键列：

| 列号 | 列名 | 说明 | 示例 |
|-----|------|------|------|
| 4 | 录入日期 | 学生录入系统日期 | `2024-01-15` |
| 5 | 上课频次 | 每周上课次数 | `2次`、`多次` |
| 6 | 上课时长 | 每次上课时长 | `2小时`、`90分钟` |
| 13 | 起止时间 | 合约有效期 | `1月-3月`、`春季` |

### 步骤2：导入学生数据

1. 点击"添加学生"
2. 复制Excel行数据
3. 粘贴到弹窗
4. 查看数据预览
   - 确认课时计算正确
   - 每周课时 = 频次 × 时长
5. 点击"保存数据"

**验证：**
- 学生卡片右上角显示课时徽章
- 格式：`剩余: XX/XX课时`

### 步骤3：导入教师和教室

1. 点击"添加教师" → 导入教师数据
2. 点击"添加教室" → 导入教室数据

### 步骤4：选择学生排课

**方式1：逐个选择**
- 点击学生卡片上的复选框

**方式2：全选**
- 点击"全选学生"按钮

**监控：**
- 已选数量显示在学生面板顶部
- 格式：`已选: X / Y`

### 步骤5：执行一键排课

1. **检查悬浮按钮状态**
   - 灰色 → 数据不足或未选择
   - 紫色 + 角标 → 准备就绪

2. **点击悬浮按钮**
   - 位置：屏幕右下角
   - 自动弹出进度浮层

3. **等待排课完成**
   - 查看当前处理的学生
   - 查看进度百分比
   - 系统自动匹配老师和教室

4. **查看结果**
   - 自动弹出结果弹窗
   - 显示成功/失败统计
   - 点击"查看最终课表"跳转

### 步骤6：查看最终课表

1. 导航到"最终课表"页面
2. 选择查看模式：
   - 学生模式
   - 老师模式
   - 教室模式
3. 导出课表

## ⚙️ 排课逻辑

### 约束条件

**硬约束：**
1. 学生有效周期：只在合约期内排课
2. 学生课时限制：课时用完自动停止
3. 老师不分身：同一时间只排一节课
4. 教室不冲突：同一时间只排一节课
5. 时间段匹配：学生+老师+教室可用时间重叠

**软约束：**
1. 优先级：优先使用高优先级教室
2. 校区匹配：尽量匹配相同校区
3. 科目匹配：老师科目与学生需求匹配

### 排课策略

1. **遗传算法优化**
   - 50代种群进化
   - 自适应变异率
   - 多目标优化

2. **智能回退**
   - 冲突自动检测
   - 自动寻找替代方案
   - 记录失败原因

3. **课时管理**
   - 实时扣除课时
   - 自动停止当课时用尽
   - 支持课时回退

## 🔧 配置与调整

### 预估周数

默认为12周，可在代码中调整：

```javascript
// frontend/src/XdfClassArranger/Function/utils/studentParser.js
const estimatedWeeks = 12; // 修改此值
```

### 默认"多次"频次

默认为4次/周，可修改：

```javascript
if (freqText.includes('多次') || freqText.includes('多回')) {
  timesPerWeek = 4; // 修改此值
}
```

### 按钮位置

悬浮按钮位置在CSS中定义：

```css
/* frontend/src/XdfClassArranger/Function/Function.css */
.floating-schedule-btn {
  bottom: 32px;  /* 距离底部 */
  right: 32px;   /* 距离右侧 */
}
```

## ⚠️ 常见问题

### Q1: 悬浮按钮是灰色的

**原因：**
- 没有导入学生数据
- 学生的频次或时长字段为空
- 计算出的课时为0

**解决：**
1. 检查Excel列5（上课频次）和列6（上课时长）
2. 确保格式正确（如`2次`、`2小时`）
3. 重新导入学生数据

### Q2: 课时计算不正确

**检查：**
1. 上课频次格式是否支持
2. 上课时长格式是否支持
3. 查看控制台警告信息

**解决：**
- 使用标准格式（见上文"支持的格式"）
- 避免使用特殊字符

### Q3: 排课失败

**可能原因：**
1. 有效周期太短
2. 老师/教室资源不足
3. 时间约束冲突

**解决：**
1. 查看结果弹窗中的错误信息
2. 调整学生时间约束
3. 增加老师或教室资源

### Q4: 有效周期显示不准确

**解决：**
1. 确保录入日期格式正确
2. 确保起止时间格式标准
3. 查看控制台日志了解解析结果

## 📊 数据流图

```
Excel数据
   ↓
[parseStudentRows]
   ↓
提取频次和时长
   ↓
[calculateWeeklyCourseHours]
   ↓
每周课时 = 频次 × 时长
总课时 = 每周课时 × 12周
   ↓
[parseValidPeriod]
   ↓
解析录入日期和起止时间
   ↓
推算有效周期区间
   ↓
学生对象（含课时和有效期）
   ↓
用户选择学生
   ↓
点击悬浮排课按钮
   ↓
[handleOneClickSchedule]
   ↓
遗传算法优化排课
   ↓
检查约束和冲突
   ↓
生成课表 + 扣除课时
   ↓
显示结果 → 最终课表
```

## 🚀 技术亮点

1. **智能解析算法**：支持多种自然语言格式
2. **实时计算**：动态计算课时，无需手动输入
3. **悬浮交互**：始终可见的操作按钮，降低误操作
4. **状态可视化**：按钮颜色和形状反映系统状态
5. **进度追踪**：实时显示排课进度和当前学生

---

**系统已完全就绪！刷新页面即可体验新功能。** 🎉

