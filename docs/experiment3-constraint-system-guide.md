# Experiment3 新约束系统使用指南

**创建日期**: 2026-02-03  
**最后更新**: 2026-02-03  
**目的**: 为非技术人员提供Experiment3新约束系统的完整使用指南

---

## 📋 目录

1. [快速开始](#快速开始)
2. [10类约束系统介绍](#10类约束系统介绍)
3. [添加和管理学生数据](#添加和管理学生数据)
4. [AI智能约束解析](#ai智能约束解析)
5. [手动编辑约束](#手动编辑约束)
6. [测试数据生成器](#测试数据生成器)
7. [排课流程](#排课流程)
8. [常见问题FAQ](#常见问题faq)

---

## 🚀 快速开始

### 5分钟完成第一次排课

1. **生成测试数据**
   - 点击右上角「测试数据」按钮
   - 选择「真实规模」预设（20学生/10教师/8教室）
   - 点击「生成测试数据」

2. **查看AI生成的约束**
   - 在左侧学生列表中点击任意学生卡片
   - 右侧将打开约束配置面板
   - 查看AI自动解析的时间窗口、课程计划等约束

3. **一键排课**
   - 点击右下角「一键排课」浮动按钮
   - 等待排课完成（20学生约需5-10秒）

4. **查看结果**
   - 在日历视图中查看排课结果
   - 切换「周视图」/「月视图」查看不同角度

---

## 📚 10类约束系统介绍

新约束系统基于真实业务需求设计，包含10种约束类型：

### 1. 🕐 时间窗口 (time_window)

**用途**: 学生可以上课或偏好上课的时间段

**示例**:
- "工作日晚上可上课" → 周一至周五 18:00-21:00
- "周末全天偏好" → 周六、周日 09:00-21:00
- "周一、周三、周五下午" → 特定日期的特定时段

**强度**: 通常为「建议满足」（软约束）

---

### 2. 🚫 禁排时间 (blackout)

**用途**: 学生绝对不能上课的时间段

**示例**:
- "语校时段不可排课" → 周一至周五 09:00-16:00
- "回国期间不上课" → 2024-12-20 至 2025-01-05
- "每周三下午有固定活动" → 每周三 13:00-17:00

**强度**: 必须满足（硬约束）

---

### 3. 📌 固定课时 (fixed_slot)

**用途**: 已经与教师约定好的固定上课时间

**示例**:
- "每周一 19:00-21:00 固定课"
- "已约定：2024-02-05 14:00-16:00"

**强度**: 必须满足（硬约束）

---

### 4. 📅 时间范围 (horizon)

**用途**: 课程必须在什么时间段内完成

**示例**:
- "2月5日之前上完"
- "1月15日到2月28日之间都可以"
- "必须在面试前（2月10日）完成"

**强度**: 必须满足（硬约束）

---

### 5. 📊 课程计划 (session_plan)

**用途**: 课程的次数、频率、时长等安排

**示例**:
- "一周2次课，每次2小时"
- "总共8次课，每次120分钟"
- "40小时课时，一周上3次"

**强度**: 建议满足（软约束）

---

### 6. 👨‍🏫 资源偏好 (resource_preference)

**用途**: 对教师、校区、教室、上课方式的偏好或限制

**子类型**:
- **教师偏好**: "指定林老师"、"不要田中老师"
- **校区偏好**: "尽量板桥校区"、"只能高马本校"
- **上课方式**: "只能线上"、"偏好线下"

**强度**: 可配置（「必须」或「建议」）

---

### 7. ⚠️ 避免冲突 (no_overlap)

**用途**: 不要与其他课程或事件冲突

**示例**:
- "不要与其他课程重叠"
- "面试课前后留30分钟缓冲"

**强度**: 必须满足（硬约束）

---

### 8. 🎯 排课策略 (strategy)

**用途**: 课程分布、阶段目标等高级策略

**示例**:
- "平均分布到各周"
- "两周内至少上4次课"
- "先写稿后练面试"

**强度**: 建议满足（软约束）

---

### 9. 💳 课时资格 (entitlement)

**用途**: 课时是否到账、订单编码等信息

**示例**:
- "课时编码：20252413"
- "已到账（2024-01-15）"

**强度**: 必须满足（硬约束）

---

### 10. 🚦 流程门禁 (workflow_gate)

**用途**: 教务流程的状态和门禁条件

**状态**: draft → 学生课时确认 → 讲师时间确认 → 教室确定 → ...

**强度**: 仅记录（info）

---

## 📥 添加和管理学生数据

### 方法一：Excel粘贴

1. 点击「添加学生」按钮
2. 从Excel复制学生数据（包括所有列）
3. 粘贴到文本框
4. 点击「解析」查看预览
5. 系统会自动询问是否进行AI约束解析

### 方法二：测试数据生成

1. 点击「测试数据」按钮
2. 选择预设或自定义数量
3. 勾选「包含约束」选项
4. 点击「生成」

### CRUD操作

**查看**: 点击学生卡片查看详细约束  
**编辑**: 在约束面板中点击「编辑」按钮  
**删除**: 悬停学生卡片，点击删除图标

---

## 🤖 AI智能约束解析

### 自动解析（推荐）

**触发时机**: 粘贴Excel数据后，系统自动询问是否进行AI解析

**优点**:
- 自动识别时间窗口（如"工作日晚上"）
- 自动识别禁排时间（如"语校时段"）
- 自动识别资源偏好（如"指定林老师"）
- 提取课程计划信息

**费用**: 约 $0.0002/学生（0.02分人民币）

### 手动解析

**使用场景**: 
- 跳过了自动解析
- 需要重新解析约束

**操作步骤**:
1. 确保学生已导入但无约束
2. 点击学生面板的「AI解析」按钮
3. 等待批量解析完成

### AI解析结果

**成功解析**: 
- 学生卡片显示「AI已解析」标签
- 约束数量显示（如「3个约束」）
- 置信度显示在约束卡片上

**解析失败**:
- 系统自动使用推断的默认约束（最大自由度）
- 您可以手动调整约束

---

## ✏️ 手动编辑约束

### 打开约束面板

点击任意学生卡片 → 右侧滑出约束配置面板

### 添加约束

1. 在约束面板中找到对应的约束类型（如「时间窗口」）
2. 点击右上角的 **+** 按钮
3. 填写约束详细信息
4. 点击「保存」

### 编辑约束

1. 点击约束卡片上的「编辑」按钮
2. 修改约束参数
3. 点击「保存」

### 使用快捷模板

编辑「时间窗口」约束时，可以使用快捷模板：
- **工作日晚上**: 周一至周五 18:00-21:00
- **周末全天**: 周六、周日 09:00-21:00
- **平日白天**: 周一至周五 09:00-17:00
- **全周可用**: 周一至周日 09:00-21:00

### 约束修改后的重新排课

修改约束后，学生卡片会显示一个橙色小点，表示约束已修改。

**重新排课方式**:
- 在约束面板底部点击「重新排课」按钮
- 或点击主界面的「一键排课」按钮

---

## 🧪 测试数据生成器

### 使用场景

- 学习和熟悉系统功能
- 测试不同规模的排课性能
- 演示系统给其他同事

### 快速生成

点击「测试数据」按钮，选择预设：

- **最小数据集** (3/2/2): 快速测试基本功能
- **真实规模** (20/10/8): 接近实际使用场景
- **压力测试** (100/30/20): 测试系统性能极限

### 自定义配置

1. 输入学生、教师、教室的数量
2. 勾选选项：
   - ✓ 包含约束：生成随机的time_window、blackout等约束
   - ✓ 包含教师可用性：为教师生成随机可用时间
3. 点击「生成测试数据」

### 数据特点

- **真实姓名**: 使用日本常见姓名
- **多样化约束**: 70%有时间窗口，30%有禁排时间，80%有课程计划
- **合理配置**: 课时、频次、时长均在合理范围内

---

## 🎯 排课流程

### 完整流程（5步骤）

```
1. 添加数据
   ↓
2. AI解析约束（或使用默认约束）
   ↓
3. 调整约束（可选）
   ↓
4. 一键排课
   ↓
5. 查看结果
```

### 排课前检查

系统会自动检查：
- ✅ 所有约束是否有效
- ✅ 是否存在冲突的约束
- ✅ 教师是否有可用时间
- ✅ 教室是否足够

### 排课算法选择

在日历上方可选择算法：
- **Greedy（贪心）**: 速度快，适合简单场景
- **Triple-Match（三方匹配）**: 综合匹配学生-教师-教室，推荐使用

### 查看排课结果

**周视图**（推荐）:
- 清晰显示每天的课程安排
- 支持拖拽调整课程时间
- 点击课程查看详情

**月视图**:
- 宏观视角查看整月安排
- 适合长期规划

---

## ❓ 常见问题FAQ

### Q1: 为什么有些学生没有排上课？

**可能原因**:
1. **时间冲突**: 学生的可用时间与教师可用时间没有交集
2. **约束过严**: 禁排时间太多，导致可排时间不足
3. **教师不足**: 没有教师可以教该科目
4. **教室不足**: 线下课需要教室，但教室已被占满

**解决方法**:
1. 检查学生的约束配置（点击学生卡片）
2. 调整时间窗口，增加可用时段
3. 减少禁排时间
4. 添加更多教师或教室

---

### Q2: AI解析的约束不准确怎么办？

**回答**: AI解析有时会出错，但您可以轻松修改：

1. 点击学生卡片打开约束面板
2. 找到不准确的约束，点击「编辑」
3. 修改参数后点击「保存」
4. 点击「重新排课」查看新结果

---

### Q3: 如何指定某个学生只能在周末上课？

**步骤**:
1. 点击学生卡片打开约束面板
2. 找到「🕐 时间窗口」，点击右上角 **+** 添加
3. 选择星期：只勾选「周六」和「周日」
4. 设置时间段：09:00-21:00
5. 约束强度选择：「必须满足」（如果是硬性要求）
6. 保存并重新排课

---

### Q4: 如何避免学生在语言学校上课期间被排课？

**步骤**:
1. 点击学生卡片打开约束面板
2. 找到「🚫 禁排时间」，点击右上角 **+** 添加
3. 选择星期：周一至周五
4. 设置时间段：09:00-16:00
5. 原因选择：「语言学校上课」
6. 保存（禁排时间自动为硬约束）

---

### Q5: 测试数据会影响真实数据吗？

**回答**: 不会！测试数据是完全独立的。

- 生成测试数据前，系统会询问是否清空现有数据
- 您可以先保存真实数据的快照（使用「Debug Log」功能）
- 测试完成后，清空数据，重新导入真实数据即可

---

### Q6: 约束修改后为什么需要重新排课？

**回答**: 约束是排课的依据，修改约束意味着需求变了。

**工作流程**:
1. 修改约束 → 学生卡片显示橙色小点
2. 点击「重新排课」→ 使用新约束重新计算
3. 查看新结果 → 小点消失

**提示**: 如果修改了多个学生的约束，可以一次性修改完再统一重新排课，节省时间。

---

### Q7: 如何理解AI解析的置信度？

**置信度说明**:
- **90%+**: AI非常确定，可以直接使用
- **70-90%**: 较确定，建议检查一下
- **50-70%**: 不太确定，建议手动调整
- **<50%**: AI猜测的，强烈建议手动检查

**建议**:
- 置信度低于70%的约束，打开查看并确认
- 特别关注时间范围和禁排时间的准确性

---

### Q8: 约束太多，排不上课怎么办？

**诊断方法**:
1. 检查「时间窗口」和「禁排时间」是否冲突
2. 查看「时间范围」约束是否过短
3. 确认「课程计划」的频次是否过高

**解决方案**:
- 删除或放宽不必要的硬约束
- 将部分硬约束改为软约束
- 调整时间窗口，增加可用时段

---

## 🔍 约束冲突检测

系统会自动检测以下冲突：

1. **时间窗口 vs 禁排时间**: 可用时间与禁排时间重叠
2. **固定课时 vs 禁排时间**: 固定课时落在禁排时段
3. **课程计划 vs 时间范围**: 课时数无法在时间范围内完成

**提示**: 排课前系统会显示冲突提示，建议修复后再排课。

---

## 💡 最佳实践

### 1. 使用AI解析节省时间

对于标准的时间表述，AI解析准确率高达90%+，可以大幅减少手动输入工作。

### 2. 先测试再应用

使用「测试数据生成器」熟悉系统后，再导入真实数据。

### 3. 合理使用约束强度

- **硬约束**：必须满足的条件（如语校时段、固定课时）
- **软约束**：尽量满足的偏好（如校区偏好、时间偏好）

太多硬约束会导致无法排课！

### 4. 定期保存快照

使用「Debug Log」功能保存当前数据快照，方便回滚。

### 5. 分批排课

如果学生很多（50+），可以分批排课：
- 选中一部分学生
- 点击「一键排课」
- 完成后再选中下一批

---

## 🛠️ 技术支持

如遇到问题，请收集以下信息联系技术支持：

1. **错误截图**
2. **Debug Log数据**（点击「Debug Log」按钮，复制学生数据）
3. **操作步骤**（重现问题的详细步骤）

---

## 📖 相关文档

- [约束抽象文档](../business/前途塾1v1_约束抽象.md) - 技术实现细节
- [Experiment3优化总结](./experiment3-optimization-summary.md) - 系统架构
- [OpenAI API配置指南](./openai-setup-guide.md) - AI功能配置

---

**祝使用愉快！有问题随时反馈。** 🎉
