# AI智能解析使用流程
# AI Smart Parsing Workflow

**Created:** 2026-01-23  
**Last Updated:** 2026-01-23  
**Purpose:** 详细说明如何使用AI智能解析功能从Excel数据中提取学生时间约束  

---

## 📋 完整工作流程

### Step 1: 打开学生编辑窗口
1. 在排课系统的Function页面中
2. 点击"添加学生"按钮
3. 会弹出 `student-edit-modal` 窗口

### Step 2: 复制Excel数据
1. 打开 `前途塾1v1约课.xlsx` 文件
2. 找到 `2512` 表格
3. 选择一整行或多行学生数据
4. 复制（Ctrl/Cmd + C）

### Step 3: 粘贴数据到编辑框
1. 在 `student-edit-modal` 的文本框中粘贴（Ctrl/Cmd + V）
2. **立即看到数据预览卡片**
   - 如果是1个学生：显示 "19 个字段"（或实际字段数）
   - 如果是多个学生：显示 "3 个学生"（或实际学生数）
   - 如果数据格式错误：显示黄色警告框

### Step 4: 点击"AI智能解析时间约束"
1. 在modal底部，有三个按钮：
   - **取消**：关闭窗口，不保存
   - **AI智能解析时间约束**：🎯 点击这个！（紫色渐变按钮）
   - **保存数据**：传统保存方式

2. 点击"AI智能解析时间约束"后：
   - `constraint-review-dialog` 会弹出（在student-edit-modal之上）
   - 自动检测到数据预览卡片中的学生
   - 显示学生统计信息

### Step 5: 在ConstraintReviewDialog中审核
#### 5.1 自动解析
1. 点击"开始批量解析"按钮
2. 实时进度条显示处理进度
3. 等待解析完成（通常每个学生2-3秒）

#### 5.2 查看结果
解析完成后，表格显示：
- **学生名称**
- **校区**
- **原始文本**：学生的时间偏好原文
- **解析结果**：
  - 允许日期（如：周一、周二、周三、周四、周五）
  - 允许时间（如：14:00-17:00）
  - 排除时间（如果有）
- **置信度**：
  - 🟢 绿色 ≥80%：高置信度，可直接批准
  - 🟡 黄色 50-80%：中等置信度，建议审核
  - 🔴 红色 <50%：低置信度，必须审核
- **状态**：待审核/已批准/已拒绝

#### 5.3 筛选和批量操作
**筛选选项**：
- 全部
- 待审核
- 已批准
- 已拒绝
- 高置信度
- 中置信度
- 低置信度

**批量操作**：
- **批量批准高置信度 (≥0.8)**：一键批准所有绿色项
- **批量拒绝低置信度 (<0.5)**：一键拒绝所有红色项

#### 5.4 单个操作
每一行有三个按钮：
- **✓ 批准**：确认这个约束正确
- **✗ 拒绝**：这个约束不正确，不导入
- **✎ 编辑**：手动修改约束

#### 5.5 编辑约束（如需要）
点击 ✎ 编辑按钮后：
1. 弹出编辑模态框（在constraint-review-dialog之上）
2. 可以：
   - **应用模板**：从10个预定义模板中选择
   - **选择允许日期**：点击切换周一到周日
   - **设置约束类型**：
     - 严格 (Strict)：必须遵守
     - 灵活 (Flexible)：建议遵守
     - 偏好 (Preferred)：优先考虑
   - **查看原始文本**：对比原始学生输入
3. 点击"保存"后：
   - 约束更新
   - 状态变为"已编辑"
   - 置信度自动设为100%

### Step 6: 最终批准并导入
1. 确认所有需要的约束都已批准或编辑
2. 点击底部的"最终批准并导入 (X个)"按钮
3. 系统会：
   - 收集所有已批准和已编辑的约束
   - 为每个学生创建带约束的排课对象
   - 自动分配颜色
   - 关闭所有对话框
   - 显示成功提示："成功导入 X 个学生约束"

### Step 7: 查看导入结果
1. 回到Function主界面
2. 在左侧学生列表中看到新导入的学生
3. 每个学生带有：
   - 姓名
   - 校区
   - 颜色标识
   - 时间约束（已解析）
   - 置信度评分

---

## 🎯 使用场景示例

### 场景1：单个学生，高置信度
```
原始文本："平日下午14:00-17:00"
↓
AI解析：
- 允许日期：周一到周五
- 允许时间：14:00-17:00
- 置信度：95%
↓
操作：点击"批准" ✓
↓
结果：直接导入，无需修改
```

### 场景2：多个学生，批量处理
```
复制3行Excel数据
↓
数据预览显示："3 个学生"
↓
点击"AI智能解析"
↓
点击"开始批量解析"
↓
等待15秒（3个学生 × 5秒/批）
↓
查看结果：
  - 学生A：置信度90% 🟢
  - 学生B：置信度85% 🟢
  - 学生C：置信度45% 🔴
↓
操作：
  1. 点击"批量批准高置信度"（学生A、B自动批准）
  2. 手动编辑学生C
  3. 点击"最终批准并导入 (3个)"
↓
结果：3个学生全部导入
```

### 场景3：需要手动修正
```
原始文本："可能下午或者晚上，看情况"
↓
AI解析：
- 允许日期：全部
- 允许时间：14:00-21:30
- 置信度：35% 🔴
↓
操作：
  1. 点击"编辑" ✎
  2. 应用模板："仅下午"
  3. 微调为14:00-18:00
  4. 保存
↓
结果：
- 状态：已编辑
- 置信度：100%
- 导入到系统
```

---

## 💡 最佳实践

### DO ✅
1. **一次处理20-30个学生**：避免API超时
2. **先批准高置信度**：节省时间
3. **仔细审核低置信度**：确保准确性
4. **使用模板快速修正**：10个预定义模板
5. **查看原始文本对比**：确认AI理解正确

### DON'T ❌
1. **不要盲目批准所有**：即使是高置信度也要快速扫一眼
2. **不要忽略警告**：黄色和红色标记需要注意
3. **不要一次处理太多**：超过50个学生会很慢
4. **不要关闭窗口不保存**：编辑后记得点"最终批准"

---

## 🔧 故障排除

### 问题1：点击"AI智能解析"没反应
**原因**：没有粘贴数据或数据格式错误  
**解决**：
1. 确认已粘贴Excel数据
2. 查看数据预览是否显示
3. 如果显示警告，检查数据格式

### 问题2：解析后置信度都很低
**原因**：原始文本过于模糊  
**解决**：
1. 检查Excel中的时间偏好列是否填写清楚
2. 手动编辑低置信度项
3. 使用模板快速设置

### 问题3：ConstraintReviewDialog被student-edit-modal挡住
**原因**：z-index层级问题（已修复）  
**解决**：
- 已将ConstraintReviewDialog的z-index提高到20000
- 如仍有问题，检查浏览器缓存

### 问题4：批准后没有导入
**原因**：忘记点"最终批准并导入"  
**解决**：
1. 批准不等于导入
2. 必须点击底部的"最终批准并导入 (X个)"按钮
3. 看到"成功导入"提示才算完成

---

## 📊 数据流程图

```
┌─────────────────────────────────────────┐
│   User 复制Excel数据到剪贴板              │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   粘贴到 student-edit-modal 文本框        │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   parseStudentRows() 解析数据             │
│   显示数据预览卡片                         │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   点击"AI智能解析时间约束"按钮             │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   转换为Excel行格式                       │
│   { '学生姓名': 'xxx', '校区': 'xxx' }   │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   ConstraintReviewDialog 弹出            │
│   extractConstraintData() 提取约束字段    │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   点击"开始批量解析"                      │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   OpenAI API 批量调用                     │
│   (5个学生/批，1秒延迟)                   │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   显示解析结果表格                         │
│   - 置信度评分                            │
│   - 约束预览                              │
│   - 状态标记                              │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   人工审核                                │
│   - 批准高置信度                          │
│   - 编辑低置信度                          │
│   - 拒绝错误项                            │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   点击"最终批准并导入 (X个)"              │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   handleNLPApproval()                   │
│   - 创建学生对象                          │
│   - 附加约束数据                          │
│   - 分配颜色                              │
│   - 添加到系统                            │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   显示成功提示                            │
│   关闭所有对话框                          │
│   返回Function主界面                      │
└─────────────────────────────────────────┘
```

---

## 🎓 Tips & Tricks

1. **快捷键**（未来计划）：
   - Enter: 批准选中项
   - Esc: 关闭对话框
   - ↑/↓: 浏览学生列表

2. **批量操作技巧**：
   - 先用筛选器查看"高置信度"
   - 一键批准所有绿色项
   - 再切换到"低置信度"逐个处理

3. **模板使用**：
   - 10个预定义模板覆盖90%的常见情况
   - 先应用模板，再微调细节
   - 比从零开始快5倍

4. **日志分析**：
   - 浏览器控制台可查看详细日志
   - 帮助调试和了解AI解析过程
   - 支持导出JSON日志文件

---

## 📞 获取帮助

如有问题：
1. 查看[完整用户指南](./NLP约束转换系统使用指南.md)
2. 查看[故障排除章节](./NLP约束转换系统使用指南.md#故障排除--troubleshooting)
3. 导出日志：`logger.downloadLogs()`
4. 联系技术支持并提供日志文件

---

**文档版本**: v1.0  
**适用于**: XDF ClassArranger v1.0+  
**最后更新**: 2026-01-23  

